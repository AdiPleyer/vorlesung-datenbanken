--- #15 

CREATE TABLE better_hotels AS 
     (SELECT * FROM hotels WHERE rating > 3)
     WITH DATA;


--- #23 ff

INSERT INTO hotels
	VALUES ('HDB-Marriot1', 'Marriot', 'Heidelberg', '4', 'Germany', 'yes');

INSERT INTO hotels (UniqueName, HotelName, City, Country)
	VALUES ('HDB-Marriot2', 'Marriot', 'Heidelberg', 'Germany');

INSERT INTO hotels (UniqueName, HotelName, City, Country, Rating)
	SELECT City || '-' || 'HDLP', 'Hotel de la Poste', City, Country, Terminals*2 
		FROM airports
		WHERE Country = 'France';


--- #25

UPDATE hotels SET Rating = '5' WHERE UniqueName = 'WSL-Palatin';

UPDATE hotels SET Rating = Rating + '1' WHERE Country = 'France' and WiFi = 'yes';
UPDATE hotels SET Rating = Rating + '1' WHERE Country = 'Germany';

UPDATE hotels SET Rating = '1';

--- RETURNING
update hotels set rating = rating where country = 'Germany' returning hotelName, rating;


--- #26

DELETE FROM hotels WHERE UniqueName = '1234-3123-SDSDF';

DELETE FROM hotels WHERE Country = 'France' and WiFi = 'yes';

DELETE FROM hotels;

--- RETURNING
DELETE FROM hotels WHERE Country = 'Germany' returning *;


-- #32 JOINs

select airport, name, code, airportname from airports join             bigairports on airport = code;
select airport, name, code, airportname from airports left outer join  bigairports on airport = code;
select airport, name, code, airportname from airports right outer join bigairports on airport = code;

select city, h.name, a.airport, a.name from hotels h join             airports a using (city) order by city;
select city, h.name, a.airport, a.name from hotels h left outer join  airports a using (city) order by city;
select city, h.name, a.airport, a.name from hotels h right outer join airports a using (city) order by city;
select city, h.name, a.airport, a.name from hotels h full outer join  airports a using (city) order by city;

select city, h.name, a.airport, a.name from hotels h natural join  airports a;


select * from hotels join             airports using (city);
select * from hotels left outer join  airports using (city);
select * from hotels right outer join airports using (city);
select * from hotels full outer join  airports using (city);



--- #43 example for CASE

SELECT
    CASE
        WHEN Rating = 5 THEN 'Mega Hotel' 
        WHEN Rating = 4 THEN 'Super Hotel'
        ELSE 'Hotel'
    END AS HotelLabel,
    hotelName, country
    FROM hotels;


--- #46 complex WHERE clause
SELECT * FROM hotels
	WHERE (rating % 3 = length(hotelName) % 3 
				AND country <> 'Germany')
		OR (country = 'Germany'
				AND rating IN (3, 5))
		OR (city = 'Wiesloch');

--- #47 Set Operations

--- cities with a hotel or an aiport
SELECT City, Rating FROM hotels
	UNION
SELECT City, Terminals FROM airports;

SELECT City FROM hotels
	UNION ALL
SELECT City FROM airports;

--- cities with a hotel but not an airport
SELECT City FROM hotels
	EXCEPT
SELECT City FROM airports;

--- cities with a hotel and an airport
SELECT City FROM hotels
	INTERSECT
SELECT City FROM airports;


--- #47

explain (analyze, verbose)
--- in DNF
SELECT * FROM hotels
	WHERE 
          (rating % 3 = length(hotelName) % 3 AND country <> 'Germany')
		OR 
          (country = 'Germany' AND rating IN (3, 5))
		OR 
          (city = 'Wiesloch');

--- in CNF
SELECT * FROM hotels
	WHERE
          (rating % 3 = length(HotelName) % 3 OR country = 'Germany' OR city = 'Wiesloch')
          AND
          (rating % 3 = length(hotelName) % 3 OR rating IN (3,5) OR city = 'Wiesloch')
          AND
          (country <> 'Germany' OR country = 'Germany' OR city = 'Wiesloch')
          AND
          (country <> 'Germany' OR rating IN (3,5) OR city = 'Wiesloch');

--- #49

SELECT * FROM airports;

SELECT ap.*
	FROM airports ap,
		(SELECT airport as mycode FROM airports
		         EXCEPT 
		 SELECT code FROM bigairports) setdiff
	WHERE ap.airport = setdiff.mycode;

SELECT *
	FROM airports ap
	WHERE not ap.airport in (SELECT code FROM bigairports);

--- #52 EXISTS
      


--- #53 Quantors

--- smallest rating overall
SELECT hotelName, Rating FROM hotels WHERE Rating <= all (SELECT Rating FROM hotels);

--- smallest rating in germany
SELECT hotelName, Rating FROM hotels
    WHERE Country = 'Germany'
        AND Rating <= ALL (SELECT Rating FROM hotels WHERE country = 'Germany');

--- smallest rating per country
SELECT Country, hotelName, Rating FROM hotels h1
    WHERE Rating <= ALL (SELECT Rating FROM hotels h2 WHERE h2.country = h1.country);


--- #54 GROUP BY and HAVING

--- average rating and count of hotels per country
SELECT AVG(Rating), COUNT(Rating), Country
	FROM hotels
	GROUP BY Country

--- hotels with above average rating per country
SELECT AVG(Rating), COUNT(Rating), Country
	FROM hotels
	GROUP BY Country
	HAVING AVG(Rating) > (SELECT AVG(Rating) 
							FROM hotels)
    order by country desc;




--- #66 demo AVG on null values

select * from Hotels;
select avg(rating) from Hotels;
select avg(rating) from Hotels where rating < 5;
update hotels set rating = null where rating = 5 returning *;
select avg(rating) from Hotels;
update hotels set rating = 5 where rating is null returning *;


